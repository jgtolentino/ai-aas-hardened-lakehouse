<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Claude Bridge</title>
  <style>
    body {
      font-family: Inter, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      font-size: 12px;
      margin: 16px;
      background: var(--figma-color-bg);
      color: var(--figma-color-text);
    }
    .status {
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 12px;
      border: 1px solid var(--figma-color-border);
    }
    .connected {
      background: var(--figma-color-bg-success);
      border-color: var(--figma-color-border-success);
    }
    .disconnected {
      background: var(--figma-color-bg-warning);
      border-color: var(--figma-color-border-warning);
    }
    .info {
      font-size: 11px;
      color: var(--figma-color-text-secondary);
      line-height: 1.4;
    }
    .badge {
      display: inline-block;
      padding: 2px 6px;
      background: var(--figma-color-bg-secondary);
      border-radius: 4px;
      font-size: 10px;
      margin-top: 4px;
    }
  </style>
</head>
<body>
  <div id="status" class="status disconnected">
    <strong>üîå Connecting to Claude MCP Hub...</strong>
    <div class="info">Waiting for local bridge connection at localhost:8787</div>
  </div>
  
  <div class="info">
    <p><strong>Claude Bridge Active</strong></p>
    <p>This plugin enables write operations from Claude Code CLI:</p>
    <ul>
      <li>Create dashboard layouts</li>
      <li>Place components</li>
      <li>Apply brand tokens</li>
      <li>Generate FigJam stickies</li>
    </ul>
    <div class="badge">Token-free ‚Ä¢ Local only ‚Ä¢ Explicit consent</div>
  </div>

  <script>
    let ws = null;
    let reconnectInterval = null;
    const statusEl = document.getElementById('status');
    
    function connect() {
      try {
        ws = new WebSocket("ws://127.0.0.1:8787/figma-bridge");
        
        ws.onopen = () => {
          console.log('Connected to Claude MCP Hub');
          statusEl.className = 'status connected';
          statusEl.innerHTML = `
            <strong>‚úÖ Connected to Claude MCP Hub</strong>
            <div class="info">Ready to receive commands from Claude Code CLI</div>
          `;
          if (reconnectInterval) {
            clearInterval(reconnectInterval);
            reconnectInterval = null;
          }
        };
        
        ws.onmessage = (ev) => {
          console.log('Received command:', ev.data);
          const cmd = JSON.parse(ev.data);
          
          // Forward command to plugin main thread
          parent.postMessage({ pluginMessage: cmd }, "*");
        };
        
        ws.onclose = (ev) => {
          console.log('WebSocket closed:', ev.code, ev.reason);
          statusEl.className = 'status disconnected';
          statusEl.innerHTML = `
            <strong>üîå Connection Lost</strong>
            <div class="info">Attempting to reconnect to MCP Hub...</div>
          `;
          
          // Auto-reconnect
          if (!reconnectInterval) {
            reconnectInterval = setInterval(() => {
              console.log('Attempting to reconnect...');
              connect();
            }, 3000);
          }
        };
        
        ws.onerror = (error) => {
          console.error('WebSocket error:', error);
        };
        
      } catch (e) {
        console.error('Failed to connect:', e);
        statusEl.className = 'status disconnected';
        statusEl.innerHTML = `
          <strong>‚ùå Connection Failed</strong>
          <div class="info">Make sure MCP Hub is running on localhost:8787</div>
        `;
      }
    }
    
    // Handle messages from plugin main thread (responses/logs)
    onmessage = (ev) => {
      if (ev.data?.pluginMessage) {
        const msg = ev.data.pluginMessage;
        
        // Forward plugin responses back to MCP Hub
        if (ws && ws.readyState === WebSocket.OPEN) {
          ws.send(JSON.stringify(msg));
        }
        
        // Handle usage logs - send to MCP Hub for Supabase storage
        if (msg.type === 'usage-log') {
          if (ws && ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify({
              type: 'store-usage-log',
              data: msg.data
            }));
          }
        }
        
        console.log('Forwarded response to MCP Hub:', msg);
      }
    };
    
    // Initial connection
    connect();
  </script>
</body>
</html>